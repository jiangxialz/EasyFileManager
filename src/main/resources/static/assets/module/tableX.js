/** 表格扩展模块 date:2020-02-29   License By http://easyweb.vip */
layui.define(["layer","table","laytpl","contextMenu"],function(e){var t=layui.jquery,a=layui.layer,o=layui.table,n=layui.laytpl,r=layui.contextMenu,i=layui.device(),l={};l.merges=function(e,a,n,r){function i(e,t,a){var n=o.cache[e];if(n.length>0){var r,i=1;r=a?n[0][a]:c.eq(0).find("td").eq(t).find(".layui-table-cell").html();for(var l=1;l<n.length;l++){var d;if((d=a?n[l][a]:c.eq(l).find("td").eq(t).find(".layui-table-cell").html())===r){if(i++,l===n.length-1){c.eq(l-i+1).find("td").eq(t).attr("rowspan",i);for(var s=1;s<i;s++)c.eq(l-s+1).find("td").eq(t).attr("del","true")}}else{c.eq(l-i).find("td").eq(t).attr("rowspan",i);for(var u=1;u<i;u++)c.eq(l-u).find("td").eq(t).attr("del","true");i=1,r=d}}}}"boolean"==typeof n&&(r=n,n=void 0);for(var d=t('[lay-filter="'+e+'"]+.layui-table-view>.layui-table-box>.layui-table-body>table'),c=d.find(">tbody>tr"),s=0;s<a.length;s++)n?i(e,a[s],n[s]):i(e,a[s]);c.find('[del="true"]').remove(),(void 0===r||r)&&o.on("sort("+e+")",function(){l.merges(e,a,n,!1)})},l.bindCtxMenu=function(e,a){var n=o.cache[e],i="#"+e+"+.layui-table-view .layui-table-body tr";t(i).bind("contextmenu",function(e){function o(e){if(e){for(var a=[],r=0;r<e.length;r++)a.push({icon:e[r].icon,name:e[r].name,_click:e[r].click,click:function(e,a){var o=t(a.currentTarget);this._click&&this._click(n[o.data("index")],a.currentTarget),o.removeClass("layui-table-click")},hr:e[r].hr,subs:o(e[r].subs)});return a}}var l=t(this);t(i).removeClass("layui-table-click"),l.addClass("layui-table-click");var d;return d="function"==typeof a?a(n[l.data("index")],e.currentTarget):a,r.show(o(d),e.clientX,e.clientY,e),!1})},l.exportData=function(e){var t=e.cols,n=e.data,r=e.fileName,d=e.expType,c=e.option;if(c||(c={}),i.ie)return a.msg("不支持ie导出");if("string"==typeof n){var s=a.load(2);return c.url=n,void l.loadUrl(c,function(t){a.close(s),e.data=t,l.exportData(e)})}for(var u=0;u<t.length;u++)for(var f=0;f<t[u].length;f++)void 0===t[u][f].type&&(t[u][f].type="normal"),void 0===t[u][f].hide&&(t[u][f].hide=!1);var p=[],v=[],h=[];o.eachCols(void 0,function(e,t){"normal"!==t.type||t.hide||(p.push(t.title||""),v.push(t.field||"txField_"+e))},t);for(var m=l.parseTbData(t,l.deepClone(n),!0),b=0;b<m.length;b++){for(var y=[],x=0;x<v.length;x++){var g=m[b][v[x]];g&&(g=g.toString().replace(/,/g,"，")),y.push(g)}h.push(y.join(","))}var w=document.createElement("a"),D={csv:"text/csv",xls:"application/vnd.ms-excel"}[d||"xls"],C=encodeURIComponent(p.join(",")+"\r\n"+h.join("\r\n"));w.href="data:"+D+";charset=utf-8,\ufeff"+C,w.download=(r||"table")+"."+(d||"xls"),document.body.appendChild(w),w.click(),document.body.removeChild(w)},l.exportDataX=function(e){layui.use("excel",function(){var t=layui.excel,n=e.cols,r=e.data,i=e.fileName,d=e.expType,c=e.option;if(c||(c={}),d||(d="xlsx"),r&&"string"==typeof r){var s=a.load(2);return c.url=r,void l.loadUrl(c,function(t){a.close(s),e.data=t,l.exportDataX(e)})}for(var u=0;u<n.length;u++)for(var f=0;f<n[u].length;f++)void 0===n[u][f].type&&(n[u][f].type="normal"),void 0===n[u][f].hide&&(n[u][f].hide=!1);var p={},v=[];o.eachCols(void 0,function(e,t){if("normal"===t.type&&!t.hide){var a=t.field||"txField_"+e;v.push(a),p[a]=t.title||""}},n);var h=l.parseTbData(n,l.deepClone(r),!0),m=t.filterExportData(h,v);m.unshift(p),t.exportExcel({sheet1:m},(i||"table")+"."+d,d)})},l.exportDataBack=function(e,a,o){if(a||(a={}),o&&"get"!==o.toString().toLowerCase()){var n='<html><body><form id="eFrom" action="'+e+'" method="'+o+'">';for(var r in a)n+='<textarea name="'+r+'">'+a[r]+"</textarea>";n+="</form></body></html>",t("#exportFrame").remove(),t("body").append('<iframe id="exportFrame" style="display: none;"></iframe>');var i=document.getElementById("exportFrame"),l=i.contentWindow,d=l.document;l.focus(),d.open(),d.write(n),d.close(),d.getElementById("eFrom").submit()}else{var c="";for(var s in a)c?c+="&"+s+"="+a[s]:c="?"+s+"="+a[s];window.open(e+c)}},l.render=function(e){var a=t(e.elem).attr("lay-filter");e.autoSort=!1;var n=o.render(e);return o.on("sort("+a+")",function(a){var o=a.field,r=a.type,i=t.extend(e.where,{sort:o,order:r});n.reload({where:i,page:{curr:1}})}),n},l.renderFront=function(e){var a,n=t(e.elem).attr("lay-filter");e.autoSort=!1;for(var r=0;r<e.cols.length;r++)for(var i=0;i<e.cols[r].length;i++)e.cols[r][i].templet&&!e.cols[r][i].field&&(e.cols[r][i].field="txField_"+r+"_"+i);if(e.url){var d=l.deepClone(e);d.data=[],d.url=void 0,a=o.render(d),a.reloadUrl=function(o){var r=l.deepClone(e);o&&(r=t.extend(r,o)),t(e.elem+"+.layui-table-view>.layui-table-box").append('<div class="layui-table-init"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i></div>'),l.loadUrl(r,function(e){a.reload({url:"",data:e,page:{curr:1}}),l.putTbData(n,l.parseTbData(r.cols,e)),t('input[tb-search="'+n+'"]').val(""),window.tbX.cacheSearch[n]=void 0})},a.reloadUrl()}else a=o.render(e),a.reloadData=function(o){a.reload(o),l.parseTbData(e.cols,o.data),l.putTbData(n,o.data),t('input[tb-search="'+n+'"]').val(""),window.tbX.cacheSearch[n]=void 0},l.putTbData(n,l.parseTbData(e.cols,e.data));return l.renderAllTool(a),a},l.loadUrl=function(e,o){e.response=t.extend({statusName:"code",statusCode:0,msgName:"msg",dataName:"data",countName:"count"},e.response);var n=e.response,r=e.where;e.contentType&&0===e.contentType.indexOf("application/json")&&(r=JSON.stringify(r)),t.ajax({type:e.method||"get",url:e.url,contentType:e.contentType,data:r,dataType:"json",headers:e.headers||{},success:function(t){if("function"==typeof e.parseData&&(t=e.parseData(t)||t),t[n.statusName]!=n.statusCode){var r=t[n.msgName]||"返回的数据不符合规范，正确的成功状态码 ("+n.statusName+") 应为："+n.statusCode;a.msg(r,{icon:2})}else o(t[n.dataName])},error:function(e,t){a.msg("数据接口请求异常："+t,{icon:2})}})},l.parseTbData=function(e,a,r){var i=[];o.eachCols(void 0,function(e,a){if(a.templet){var o={field:a.field&&(r||0===a.field.indexOf("txField_"))?a.field:"txField_"+e};"string"==typeof a.templet?o.templet=function(e){var o=void 0;return n(t(a.templet).html()).render(e,function(e){o=e}),o}:o.templet=a.templet,i.push(o)}},e);for(var l=0;l<a.length;l++)for(var d=a[l],c=0;c<i.length;c++){var s="<div>"+i[c].templet(d)+"</div>";d[i[c].field]=t(s).not(".export-hide").text().replace(/(^\s*)|(\s*$)/g,"")}return a},l.putTbData=function(e,t){window.tbX.cache[e]=t},l.getTbData=function(e){var t=window.tbX.cache[e];return l.deepClone(t||o.cache[e])},l.filterData=function(e,t,a){for(var o,n=[],r=0;r<e.length;r++){var i=e[r];if(!o)if(t)o=t.split(",");else{o=[];for(var d in i)i.hasOwnProperty(d)&&o.push(d)}for(var c=0;c<o.length;c++)if(l.isContains(i[o[c]],a)){n.push(i);break}}return n},l.isContains=function(e,t){return e||(e=""),t||(t=""),e=e.toString().toLowerCase(),t=t.toString().toLowerCase(),e===t||e.indexOf(t)>=0},l.renderAllTool=function(e){s(e),c(e),d(e),u(e)},l.deepClone=function(e){var t,a=l.isClass(e);if("Object"===a)t={};else{if("Array"!==a)return e;t=[]}for(var o in e)if(e.hasOwnProperty(o)){var n=e[o];"Object"===l.isClass(n)?t[o]=arguments.callee(n):"Array"===l.isClass(n)?t[o]=arguments.callee(n):t[o]=e[o]}return t},l.isClass=function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)},window.tbX||(window.tbX={}),window.tbX.cache||(window.tbX.cache={}),window.tbX.cacheSearch||(window.tbX.cacheSearch={});var d=function(e){var o=e.config.id,n=t('input[tb-search="'+o+'"]');n&&n.length>0&&(n.attr("placeholder")||n.attr("placeholder","输入关键字按回车键搜索"),n.off("keydown").on("keydown",function(t){if(13===t.keyCode){var r=n.attr("name"),i=n.val().replace(/(^\s*)|(\s*$)/g,""),d=a.msg("搜索中..",{icon:16,shade:.01,time:0}),c=l.getTbData(o),s=l.filterData(c,r,i);window.tbX.cacheSearch[o]=s,e.reload({url:"",data:s,page:{curr:1}}),a.close(d)}}))},c=function(e){var t=e.config.id;o.on("sort("+t+")",function(o){var n=o.field,r=o.type,i=a.msg("加载中..",{icon:16,shade:.01,time:0}),d=window.tbX.cacheSearch[t];d||(d=l.getTbData(t)),r&&(d=d.sort(function(e,t){var a=e[n],o=t[n];return"asc"===r?a===o?0:a<o?-1:1:a===o?0:a<o?1:-1})),e.reload({initSort:o,url:"",data:d,page:{curr:1}}),a.close(i)})},s=function(e){t('[tb-refresh="'+e.config.id+'"]').off("click").on("click",function(){e.reloadUrl?e.reloadUrl():e.reload({page:{curr:1}})})},u=function(e){var n=e.config.id;t('[tb-export="'+n+'"]').off("click").on("click",function(r){if(!(t(this).find(".tbx-dropdown-menu").length>0)){void 0!==r&&(r.preventDefault(),r.stopPropagation());var i='<div class="tbx-dropdown-menu">';i+='      <div class="tbx-dropdown-menu-item" data-type="check">导出选中数据</div>',i+='      <div class="tbx-dropdown-menu-item" data-type="current">导出当前页数据</div>',i+='      <div class="tbx-dropdown-menu-item" data-type="all">导出全部数据</div>',i+="   </div>",t(this).append(i),t(this).addClass("tbx-dropdown-btn"),t(this).parent().css("position","relative"),t(this).parent().css("z-index","9998"),t(".tbx-dropdown-menu").off("click").on("click",".tbx-dropdown-menu-item",function(r){var i=t(this).data("type");if("check"===i){var d=o.checkStatus(n);0===d.data.length?a.msg("请选择要导出的数据",{icon:2}):(t(".tbx-dropdown-menu").remove(),l.exportData({fileName:e.config.title,cols:e.config.cols,data:d.data}))}else"current"===i?l.exportData({fileName:e.config.title,cols:e.config.cols,data:o.cache[n]}):"all"===i&&l.exportData({fileName:e.config.title,cols:e.config.cols,data:l.getTbData(n)});void 0!==r&&(r.preventDefault(),r.stopPropagation())})}}),t(document).off("click.tbxDropHide").on("click.tbxDropHide",function(){t(".tbx-dropdown-menu").remove()})};t("head").append('<style id="ew-css-tbx" type="text/css">'+function(){var e=".tbx-dropdown-btn {";return e+="        position: relative;",e+="   }",e+="   .tbx-dropdown-btn:hover {",e+="        opacity: 1",e+="   }",e+="   .tbx-dropdown-menu {",e+="        position: absolute;",e+="        top: 100%;",e+="        right: 0;",e+="        padding: 5px 0;",e+="        margin: 5px 0 0 0;",e+="        overflow: visible;",e+="        min-width: 110px;",e+="        background: #fff;",e+="        border-radius: 2px;",e+="        box-shadow: 0 2px 4px rgba(0, 0, 0, .12);",e+="        border: 1px solid #d2d2d2;",e+="        z-index: 9998;",e+="        cursor: default;",e+="   }",e+="   .tbx-dropdown-menu .tbx-dropdown-menu-item {",e+="        display: block;",e+="        color: #555;",e+="        font-size: 14px;",e+="        padding: 10px 15px;",e+="        text-decoration: none;",e+="        white-space: nowrap;",e+="        cursor: pointer;",e+="        user-select: none;",e+="        line-height: normal;",e+="   }",e+="   .tbx-dropdown-menu .tbx-dropdown-menu-item:hover {",e+="        background-color: #eeeeee;",e+="   }",e+="   .export-show {",e+="        display: none;",e+="   }"}()+"</style>"),e("tableX",l)});